<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="image" href="https://markdown-img-1304853431.file.myqcloud.com/20220119171645.jpg"/><link rel="preload" as="image" href="http://markdown-img-1304853431.cosgz.myqcloud.com/20220509205039.png"/><link rel="preload" as="image" href="http://markdown-img-1304853431.cosgz.myqcloud.com/20220509211227.png"/><link rel="stylesheet" href="/_next/static/css/0cb6a7725f1de3c8.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/736bd5ba25105f3a.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-958a1045c5f493e6.js"/><script src="/_next/static/chunks/56bf5c7b-567d655a0c2508ae.js" async=""></script><script src="/_next/static/chunks/416-e71c7162c9bf5c4f.js" async=""></script><script src="/_next/static/chunks/main-app-d9b9a3397237f2d4.js" async=""></script><script src="/_next/static/chunks/1727213d-ed770260b52092c7.js" async=""></script><script src="/_next/static/chunks/192-63f0035328ebab3b.js" async=""></script><script src="/_next/static/chunks/app/error-06967b165f29cafe.js" async=""></script><script src="/_next/static/chunks/34ba9a00-8ebd521ae784f68d.js" async=""></script><script src="/_next/static/chunks/b2e9d811-b5814f97a31d63ea.js" async=""></script><script src="/_next/static/chunks/386-12980df3d0e2e1b1.js" async=""></script><script src="/_next/static/chunks/898-c173b3dbe263bab1.js" async=""></script><script src="/_next/static/chunks/855-be902fd28fe769ab.js" async=""></script><script src="/_next/static/chunks/app/posts/%5Bslug%5D/page-1919972ba9ee31de.js" async=""></script><title>Yutian&#x27;s Blog</title><meta name="description" content="A place for me to create and share"/><link rel="manifest" href="/favicon/site.webmanifest" crossorigin="use-credentials"/><meta name="robots" content="index, follow"/><meta property="og:title" content="Yutian&#x27;s Blog"/><meta property="og:description" content="A place for me to create and share"/><meta property="og:url" content="https://www.yutianchen.blog"/><meta property="og:site_name" content="Yutian&#x27;s Blog"/><meta property="og:locale" content="en_US"/><meta property="og:image" content="https://www.yutianchen.blog/images/og.jpg"/><meta property="og:type" content="website"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="Yutian&#x27;s Blog"/><meta name="twitter:description" content="A place for me to create and share"/><meta name="twitter:image" content="https://www.yutianchen.blog/images/og.jpg"/><link rel="shortcut icon" href="/favicon/favicon-16x16.png"/><link rel="icon" href="/favicon/favicon.ico"/><link rel="apple-touch-icon" href="/favicon/apple-touch-icon.png"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body><article class="rendered-markdown"><div class="min-h-screen flex flex-col"><div class="absolute inset-0 bg-cover bg-center blur-sm -z-10 trans" style="background-image:url(/_next/static/media/AntelopeCanyon.f3e0200c.jpg)"></div><header class="bg-cover bg-center h-80 flex items-center justify-center bg-white bg-opacity-70 p-4"><h1 class="text-primary-900 text-5xl font-bold">Build Your Own Google Drive with AWS S3</h1></header><div class="bg-slate-50"><nav class="sticky top-0 z-20 flex flex-row flex-nowrap justify-around items-stretch bg-white/60 backdrop-blur-[4px]"><a class="flex-grow text-center font-bold p-3 cursor-pointer border-b-4 hover:border-primary-400 hover:text-primary-500 animated-underline" href="/">About Me</a><a class="flex-grow text-center font-bold p-3 cursor-pointer border-b-4 hover:border-primary-400 hover:text-primary-500 animated-underline" href="/posts">Posts</a><a class="flex-grow text-center font-bold p-3 cursor-pointer border-b-4 hover:border-primary-400 hover:text-primary-500 animated-underline" href="/notes">Notes</a></nav><div class="flex flex-1 max-w-screen-xl mx-auto min-h-screen"><aside class="hidden lg:block w-80 p-4 sticky top-12 h-screen overflow-y-auto"><nav><h3 class="pb-4 text-primary-900">Table of Content</h3><span class="italic text-neutral-500">No headings in this page</span></nav></aside><main class="flex-1 p-4 w-full"><article class="react-md-render"><p>This system is deployed on <a href="/notes">My blog&#x27;s file Sharing Page</a> as a front-end application. The source code is also avalable in <code>React-S3-Viewer</code> Repo <a href="https://github.com/MarkChenYutian/React-S3-viewer">here</a>.</p>
<p>Reference Information:</p>
<ul>
<li><a href="https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/s3-example-photos-view.html">Viewing Photo stored in S3 Buckets</a></li>
<li><a href="https://docs.aws.amazon.com/sdk-for-javascript/v3/developer-guide/welcome.html">AWS SDK for JavaScript</a></li>
<li><a href="https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/getting-started-browser.html#getting-started-browser-create-identity-pool">AWS Cognito Identity Pool</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/sessionStorage">SessionStorage - MDN</a></li>
</ul>
<h2 id="access-aws-resources-through-sdk">Access AWS Resources through SDK</h2><a href="#access-aws-resources-through-sdk"><span class="icon icon-link"></span></a>
<p><img src="https://markdown-img-1304853431.file.myqcloud.com/20220119171645.jpg" alt="Serverless-file-system"/></p>
<p>A user identity pool is created using AWS Cognito. Any user authenticated / unauthenticated join this identity pool will be automatically assigned with an AWS role. Then, we create a AWS SDK key corresponding to this identity pool. Anyone access AWS Service using SDK and given key will get an role called <code>Cognito_MyBlogFilesUnAuth_Role</code>.</p>
<!-- -->
<p>Using IAM, we can assign this role with permission to access some specific AWS Resource. In this case, we only allow users to access the S3 storage bucket <code>yutian-public</code> and allow them to <code>List</code> and <code>Get</code> objects from the bucket.</p>
<pre><code class="language-json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Sid&quot;: &quot;VisualEditor0&quot;,
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: &quot;s3:ListBucket&quot;,
            &quot;Resource&quot;: &quot;arn:aws:s3:::yutian-public&quot;
        },
        {
            &quot;Sid&quot;: &quot;VisualEditor1&quot;,
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: &quot;s3:GetObject&quot;,
            &quot;Resource&quot;: &quot;arn:aws:s3:::yutian-public/*&quot;
        }
    ]
}
</code></pre>
<h2 id="local-caching">Local Caching</h2><a href="#local-caching"><span class="icon icon-link"></span></a>
<p>Since 2022 May, the file sharing page is reconstructed using <code>React</code> and <code>Ant-design</code>. Two major improvements are implemented in this latest version:</p>
<ol>
<li>
<p>The file directory will be cached in the <code>SessionStorage</code>. For each session, the client will only request once from the AWS. This can significantly reduce the #requests.</p>
</li>
<li>
<p>When downloading, files will be cached to the <code>IndexDB</code>. Therefore, unless the user reset the IndexDB or the file is updated, every file is guaranteed to be downloaded only once on each client.</p>
</li>
</ol>
<h3 id="file-list-cache">File List Cache</h3><a href="#file-list-cache"><span class="icon icon-link"></span></a>
<p><img src="http://markdown-img-1304853431.cosgz.myqcloud.com/20220509205039.png" alt="File Structure saved in Session Storage"/></p>
<p>When the page is first loaded, the client will request all objects in S3 storage bucket through <code>ListObjectV2</code> API. The result is a list of objects in the bucket.</p>
<p>There is no file structure in S3, all the &quot;folders&quot; are just key of object with <code>/</code> slashes between words. Therefore, we need to parse the result to rebuild a &quot;file structure&quot; back from plain list.</p>
<p>The file structure will then be stored into <code>SessionStorage</code>. Unless the user explicitly request for reload, the <code>ListObjectV2</code> API will not be called anymore in current session.</p>
<h3 id="file-content-cache">File Content Cache</h3><a href="#file-content-cache"><span class="icon icon-link"></span></a>
<p><img src="http://markdown-img-1304853431.cosgz.myqcloud.com/20220509211227.png" alt="image-20220509211227847"/></p>
<p>On the other hand, we want to reduce the amount of data downloaded from the AWS to minimize cost. Therefore, we want to cache the files that users has downloaded previously.</p>
<p>We will need to use <code>IndexedDB</code> since the quota for session storage is very small (~1Mb per entry). IndexedDB is much more complicated to use than SessionStorage. Luckily, there&#x27;s a third-party module called <code>idb-key-val</code> that allows us to use IndexDB in an extremely simple way.</p>
<pre><code class="language-typescript">function set(key: string, val: any)

function get(key: string): Promise&lt;any&gt;
</code></pre>
<p>By converting <code>Uint8Array</code> to base64 string, we can store the file in client&#x27;s cache and reduce the redundant request to AWS.</p>
<p><mark>Yet, there is just <strong>one more thing</strong></mark></p>
<p>Suppose the file on S3 is updated to a newer version but the client is still caching the older version, how can the client know when to update/descard the cache?</p>
<p>We resolve this problem by storing the <code>ETag</code> field along with data. <code>ETag</code> is a string that reflects the change of file content (notice it&#x27;s not necessarily MD5). When the key is requested, the program will also compare the <code>ETag</code> of requested resource and current cache. If they don&#x27;t match, then a later version will overwrite the current cache.</p></article></main></div><div><footer class="min-h-24 items-center justify-center py-12 text-center border-t-2 border-slate-200">Â© <!-- -->2025<!-- --> By<!-- --> <a target="_blank" rel="noopener noreferrer" href="https://www.yutianchen.blog/" class="cursor-newtab animated-underline custom-link inline-flex items-center font-medium focus-visible:ring-primary-500 focus:outline-none focus-visible:rounded focus-visible:ring focus-visible:ring-offset-2 border-dark border-b border-dotted hover:border-black/0">Yutian Chen</a></footer></div></div></div></article><script src="/_next/static/chunks/webpack-958a1045c5f493e6.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/0cb6a7725f1de3c8.css\",\"style\"]\n2:HL[\"/_next/static/css/736bd5ba25105f3a.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"3:I[6628,[],\"\"]\n6:I[242,[],\"\"]\n8:I[3562,[],\"\"]\n9:I[3154,[\"407\",\"static/chunks/1727213d-ed770260b52092c7.js\",\"192\",\"static/chunks/192-63f0035328ebab3b.js\",\"601\",\"static/chunks/app/error-06967b165f29cafe.js\"],\"default\"]\nb:I[2769,[],\"\"]\n7:[\"slug\",\"s3-fs\",\"d\"]\nc:[]\n"])</script><script>self.__next_f.push([1,"0:[\"$\",\"$L3\",null,{\"buildId\":\"G85UdOlpqLRwD3iqgZ677\",\"assetPrefix\":\"\",\"urlParts\":[\"\",\"posts\",\"s3-fs\"],\"initialTree\":[\"\",{\"children\":[\"posts\",{\"children\":[[\"slug\",\"s3-fs\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"s3-fs\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"posts\",{\"children\":[[\"slug\",\"s3-fs\",\"d\"],{\"children\":[\"__PAGE__\",{},[[\"$L4\",\"$L5\",null],null],null]},[null,[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\",\"$7\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[null,[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\"}]],null]},[[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/0cb6a7725f1de3c8.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/736bd5ba25105f3a.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"children\":[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$9\",\"errorStyles\":[],\"errorScripts\":[],\"template\":[\"$\",\"$L8\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[\"$\",\"main\",null,{\"children\":[\"$\",\"section\",null,{\"className\":\"bg-white\",\"children\":[\"$\",\"div\",null,{\"className\":\"layout flex min-h-screen flex-col items-center justify-center text-center text-black\",\"children\":[[\"$\",\"svg\",null,{\"stroke\":\"currentColor\",\"fill\":\"currentColor\",\"strokeWidth\":\"0\",\"viewBox\":\"0 0 24 24\",\"className\":\"drop-shadow-glow animate-flicker text-red-500\",\"children\":[\"$undefined\",[[\"$\",\"path\",\"0\",{\"d\":\"M4.00001 20V14C4.00001 9.58172 7.58173 6 12 6C16.4183 6 20 9.58172 20 14V20H21V22H3.00001V20H4.00001ZM6.00001 14H8.00001C8.00001 11.7909 9.79087 10 12 10V8C8.6863 8 6.00001 10.6863 6.00001 14ZM11 2H13V5H11V2ZM19.7782 4.80761L21.1924 6.22183L19.0711 8.34315L17.6569 6.92893L19.7782 4.80761ZM2.80762 6.22183L4.22183 4.80761L6.34315 6.92893L4.92894 8.34315L2.80762 6.22183Z\",\"children\":[]}]]],\"style\":{\"color\":\"$undefined\"},\"height\":60,\"width\":60,\"xmlns\":\"http://www.w3.org/2000/svg\"}],[\"$\",\"h1\",null,{\"className\":\"mt-8 text-4xl md:text-6xl\",\"children\":\"Page Not Found\"}],[\"$\",\"a\",null,{\"href\":\"/\",\"children\":\"Back to home\"}]]}]}]}],\"notFoundStyles\":[]}]}]}]],null],null],\"couldBeIntercepted\":false,\"initialHead\":[null,\"$La\"],\"globalErrorComponent\":\"$b\",\"missingSlots\":\"$Wc\"}]\n"])</script><script>self.__next_f.push([1,"d:I[9913,[\"988\",\"static/chunks/34ba9a00-8ebd521ae784f68d.js\",\"574\",\"static/chunks/b2e9d811-b5814f97a31d63ea.js\",\"386\",\"static/chunks/386-12980df3d0e2e1b1.js\",\"192\",\"static/chunks/192-63f0035328ebab3b.js\",\"898\",\"static/chunks/898-c173b3dbe263bab1.js\",\"855\",\"static/chunks/855-be902fd28fe769ab.js\",\"333\",\"static/chunks/app/posts/%5Bslug%5D/page-1919972ba9ee31de.js\"],\"default\"]\ne:T11e0,"])</script><script>self.__next_f.push([1,"---\ntitle: \"Build Your Own Google Drive with AWS S3\"\ntags : [\"Frontend\"]\ndate: 2022-01-19\n---\n\nThis system is deployed on [My blog's file Sharing Page](/notes) as a front-end application. The source code is also avalable in `React-S3-Viewer` Repo [here](https://github.com/MarkChenYutian/React-S3-viewer).\n\nReference Information:\n\n* [Viewing Photo stored in S3 Buckets](https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/s3-example-photos-view.html)\n* [AWS SDK for JavaScript](https://docs.aws.amazon.com/sdk-for-javascript/v3/developer-guide/welcome.html)\n* [AWS Cognito Identity Pool](https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/getting-started-browser.html#getting-started-browser-create-identity-pool)\n* [SessionStorage - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Window/sessionStorage)\n\n## Access AWS Resources through SDK\n\n![Serverless-file-system](https://markdown-img-1304853431.file.myqcloud.com/20220119171645.jpg)\n\nA user identity pool is created using AWS Cognito. Any user authenticated / unauthenticated join this identity pool will be automatically assigned with an AWS role. Then, we create a AWS SDK key corresponding to this identity pool. Anyone access AWS Service using SDK and given key will get an role called `Cognito_MyBlogFilesUnAuth_Role`.\n\n\u003c!--more--\u003e\n\n\nUsing IAM, we can assign this role with permission to access some specific AWS Resource. In this case, we only allow users to access the S3 storage bucket `yutian-public` and allow them to `List` and `Get` objects from the bucket.\n\n```json\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Sid\": \"VisualEditor0\",\n            \"Effect\": \"Allow\",\n            \"Action\": \"s3:ListBucket\",\n            \"Resource\": \"arn:aws:s3:::yutian-public\"\n        },\n        {\n            \"Sid\": \"VisualEditor1\",\n            \"Effect\": \"Allow\",\n            \"Action\": \"s3:GetObject\",\n            \"Resource\": \"arn:aws:s3:::yutian-public/*\"\n        }\n    ]\n}\n```\n\n## Local Caching\n\nSince 2022 May, the file sharing page is reconstructed using `React` and `Ant-design`. Two major improvements are implemented in this latest version:\n\n1. The file directory will be cached in the `SessionStorage`. For each session, the client will only request once from the AWS. This can significantly reduce the #requests.\n\n2. When downloading, files will be cached to the `IndexDB`. Therefore, unless the user reset the IndexDB or the file is updated, every file is guaranteed to be downloaded only once on each client.\n\n### File List Cache\n\n![File Structure saved in Session Storage](http://markdown-img-1304853431.cosgz.myqcloud.com/20220509205039.png)\n\nWhen the page is first loaded, the client will request all objects in S3 storage bucket through `ListObjectV2` API. The result is a list of objects in the bucket.\n\nThere is no file structure in S3, all the \"folders\" are just key of object with `/` slashes between words. Therefore, we need to parse the result to rebuild a \"file structure\" back from plain list.\n\nThe file structure will then be stored into `SessionStorage`. Unless the user explicitly request for reload, the `ListObjectV2` API will not be called anymore in current session.\n\n### File Content Cache\n\n![image-20220509211227847](http://markdown-img-1304853431.cosgz.myqcloud.com/20220509211227.png)\n\nOn the other hand, we want to reduce the amount of data downloaded from the AWS to minimize cost. Therefore, we want to cache the files that users has downloaded previously.\n\nWe will need to use `IndexedDB` since the quota for session storage is very small (~1Mb per entry). IndexedDB is much more complicated to use than SessionStorage. Luckily, there's a third-party module called `idb-key-val` that allows us to use IndexDB in an extremely simple way.\n\n```typescript\nfunction set(key: string, val: any)\n\nfunction get(key: string): Promise\u003cany\u003e\n```\n\nBy converting `Uint8Array` to base64 string, we can store the file in client's cache and reduce the redundant request to AWS.\n\n\u003cmark\u003eYet, there is just **one more thing**\u003c/mark\u003e\n\nSuppose the file on S3 is updated to a newer version but the client is still caching the older version, how can the client know when to update/descard the cache?\n\nWe resolve this problem by storing the `ETag` field along with data. `ETag` is a string that reflects the change of file content (notice it's not necessarily MD5). When the key is requested, the program will also compare the `ETag` of requested resource and current cache. If they don't match, then a later version will overwrite the current cache."])</script><script>self.__next_f.push([1,"5:[\"$\",\"article\",null,{\"className\":\"rendered-markdown\",\"children\":[\"$\",\"$Ld\",null,{\"content\":\"$e\"}]}]\na:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Yutian's Blog\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"A place for me to create and share\"}],[\"$\",\"link\",\"4\",{\"rel\":\"manifest\",\"href\":\"/favicon/site.webmanifest\",\"crossOrigin\":\"use-credentials\"}],[\"$\",\"meta\",\"5\",{\"name\":\"robots\",\"content\":\"index, follow\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:title\",\"content\":\"Yutian's Blog\"}],[\"$\",\"meta\",\"7\",{\"property\":\"og:description\",\"content\":\"A place for me to create and share\"}],[\"$\",\"meta\",\"8\",{\"property\":\"og:url\",\"content\":\"https://www.yutianchen.blog\"}],[\"$\",\"meta\",\"9\",{\"property\":\"og:site_name\",\"content\":\"Yutian's Blog\"}],[\"$\",\"meta\",\"10\",{\"property\":\"og:locale\",\"content\":\"en_US\"}],[\"$\",\"meta\",\"11\",{\"property\":\"og:image\",\"content\":\"https://www.yutianchen.blog/images/og.jpg\"}],[\"$\",\"meta\",\"12\",{\"property\":\"og:type\",\"content\":\"website\"}],[\"$\",\"meta\",\"13\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"14\",{\"name\":\"twitter:title\",\"content\":\"Yutian's Blog\"}],[\"$\",\"meta\",\"15\",{\"name\":\"twitter:description\",\"content\":\"A place for me to create and share\"}],[\"$\",\"meta\",\"16\",{\"name\":\"twitter:image\",\"content\":\"https://www.yutianchen.blog/images/og.jpg\"}],[\"$\",\"link\",\"17\",{\"rel\":\"shortcut icon\",\"href\":\"/favicon/favicon-16x16.png\"}],[\"$\",\"link\",\"18\",{\"rel\":\"icon\",\"href\":\"/favicon/favicon.ico\"}],[\"$\",\"link\",\"19\",{\"rel\":\"apple-touch-icon\",\"href\":\"/favicon/apple-touch-icon.png\"}]]\n4:null\n"])</script></body></html>